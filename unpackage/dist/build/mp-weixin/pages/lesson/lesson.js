"use strict";const e=require("../../common/vendor.js"),t=require("../../store/lesson.js"),s=require("../../store/student.js"),o=require("../../utils/constant.js"),r=require("../../utils/utils.js"),a=require("../../utils/request.js");var n="https://lesson-api.jc-talent.com";if(!Array){(e.resolveComponent("bruce-calendar")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-swipe-action-item")+e.resolveComponent("uni-swipe-action")+e.resolveComponent("uni-fab")+e.resolveComponent("uni-notice-bar")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-forms-item")+e.resolveComponent("editable-select")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("time-range-picker")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/bruce-calendar/components/bruce-calendar/bruce-calendar.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-swipe-action/components/uni-swipe-action-item/uni-swipe-action-item.js")+(()=>"../../uni_modules/uni-swipe-action/components/uni-swipe-action/uni-swipe-action.js")+(()=>"../../uni_modules/uni-fab/components/uni-fab/uni-fab.js")+(()=>"../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js")+(()=>"../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/editable-select/components/editable-select/editable-select.js")+(()=>"../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../uni_modules/time-range-picker/components/time-range-picker/time-range-picker.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const u={__name:"lesson",setup(u){const i=e.ref(),l=e.ref(),c=e.ref();t.useLessonStore();const d=s.useStudentStore(),p=e.ref([]),m=e.ref([]),v=e.reactive({}),b=e.ref([]),f=e.ref([]),h=e.ref([]);e.watch([()=>v.subject,b],(([e,t],[s,o])=>{var r;const a=null==(r=b.value)?void 0:r.find((t=>t.subject==e));f.value=a?a.teachers:[],e!==s&&(v.teacher="")}),{immediate:!0,deep:!0});const j=e.ref([{text:"取消",style:{backgroundColor:"#F56C6C"}},{text:"完成",style:{backgroundColor:"#00f200"}}]),g=e=>{b.value=b.value||[];const t=b.value.find((e=>e.subject==v.subject));t?t.teachers=e:b.value.push({subject:String(v.subject),teachers:e})},w=e=>{h.value=e},y=e=>{v.teacher=e},q=e=>{v.classroom=e},S=()=>{a.request({url:`${n}/users/config`,method:"POST",data:{teacherOptions:b.value}})},$=()=>{a.request({url:`${n}/users/config`,method:"POST",data:{classroomOptions:h.value}})},x=e.ref({subject:{rules:[{required:!0,errorMessage:"科目不能为空"}]},type:{rules:[{required:!0,errorMessage:"课程类型不能为空"}]},teacher:{rules:[{required:!0,errorMessage:"教师不能为空"}]},classroom:{rules:[{required:!0,errorMessage:"教室不能为空"}]},date:{rules:[{required:!0,errorMessage:"日期不能为空"}]},time:{rules:[{required:!0,errorMessage:"时间不能为空"}]}}),k=e.computed((()=>o.subjectOptions.filter((e=>d.subjects.includes(e.value))))),_=o.typeOptions.filter((e=>1===e.value?d.remainHours.hours1v1>0:3===e.value&&d.remainHours.hours1v3>0)).map((e=>1===e.value?{value:e.value,text:e.text+`(剩余：${d.remainHours.hours1v1} 课时)`}:{value:e.value,text:e.text+`(剩余：${d.remainHours.hours1v3} 课时)`})),C=e=>["is-init","is-approved","is-draft"][e]||"",O=e.ref(),T=()=>O.value.open(),M=()=>O.value.close(),F=async()=>{if(l.value){await l.value.validate()&&e.index.requestSubscribeMessage({tmplIds:["UO10oiJFF9vEhkty7lvT7Q0DY2jXF4QdNn8WqHlVrdI","0A6-dgr7vyyrZdprmGcFEwxjpNj9vPuvRDVxw5tYI6A"],success:t=>{"accept"===t.UO10oiJFF9vEhkty7lvT7Q0DY2jXF4QdNn8WqHlVrdI||"accept"===t["0A6-dgr7vyyrZdprmGcFEwxjpNj9vPuvRDVxw5tYI6A"]?a.request({url:`${n}/students/${d.id}/lessons`,method:"POST",data:v,success:()=>{e.index.showToast({title:"添加成功",icon:"success"}),setTimeout((()=>{M(),i.value.init(v.date),i.value.change()}),1500)}}):e.index.showToast({title:"请允许订阅通知",icon:"error"})}})}},H=(e,t,s="")=>{const o=`${e}-${String(t).padStart(2,"0")}`,r=s?`${o}-${String(s).padStart(2,"0")}`:o;P(o,r)},I=e=>{const{year:t,month:s,date:o}=e;H(t,s,o)},V=e=>{const{year:t,month:s}=e;H(t,s)},A=e=>{v.time=e},D=(e,t=!0)=>{const s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`;if(t){return`${s}-${String(e.getDate()).padStart(2,"0")}`}return s},E=(t,s)=>{a.request({url:`${n}/lessons/${t.id}`,method:"POST",data:t,success:()=>{d.deductHours(t.type),e.index.showToast({title:s})}})},P=(e,t)=>{a.request({url:`${n}/students/${d.id}/lessons?month=${e}&date=${t}`,method:"GET",success:e=>{const{dailySchedules:t,currentSchedules:s}=e.data.data;p.value=t.map((e=>({date:e,color:"red",icon:"flag-filled"}))),m.value=s.map((e=>({id:e.lessonId,status:e.status,subject:e.subject,type:e.type,classroom:e.classroom,teacher:e.teacher,time:`${e.startTime}-${e.endTime}`})))}})};return e.onBeforeMount((()=>{const e=new Date;P(D(e,!1),D(e)),a.request({url:`${n}/users/config`,method:"GET",success:e=>{if(e.data.data){const{teacherOptions:t,classroomOptions:s}=e.data.data;b.value=t,h.value=s}}})})),(t,s)=>e.e({a:e.sr(i,"9951b953-0",{k:"calRef"}),b:e.o(I),c:e.o(V),d:e.p({selected:p.value,insert:!0,lunar:!0,"start-date":"2000-1-1","end-date":"2099-12-31"}),e:e.f(m.value,((t,s,o)=>{return{a:e.t((n=t.status,["待上课","已上课","已取消"][n]||"")),b:e.n(C(t.status)),c:e.t(e.unref(r.formatSubject)(t.subject)),d:e.t((a=t.type,1===a?"一对一":"一对三")),e:e.t(t.time),f:"9951b953-3-"+o+",9951b953-2-"+o,g:e.t(t.classroom),h:"9951b953-4-"+o+",9951b953-2-"+o,i:e.t(t.teacher),j:e.n({"freezon-course-info":0!==t.status}),k:t.id,l:e.o((s=>(async(t,s)=>{const{index:o}=t;try{0===o?(await e.index.showModal({title:"确认取消？"}),s.status=2,E(s,"取消成功")):(s.status=1,E(s,"完成成功"))}catch(r){console.error("Modal error:",r)}finally{c.value.closeAll()}})(s,t)),t.id),m:"9951b953-2-"+o+",9951b953-1",n:e.p({"right-options":j.value,disabled:0!==t.status})};var a,n})),f:e.p({type:"home",size:"16",color:"#7f8c8d"}),g:e.p({"custom-prefix":"iconfont",type:"icon-teacher",color:"#7f8c8d"}),h:e.sr(c,"9951b953-1",{k:"swipeRef"}),i:e.o(T),j:e.p({horizontal:"right"}),k:e.p({"show-icon":!0,"background-color":"#eee",color:"#888",text:"将为【"+e.unref(d).name+"】添加课程"}),l:e.o((()=>{})),m:e.o((e=>v.subject=e)),n:e.p({localdata:k.value,placeholder:"请选择科目",modelValue:v.subject}),o:e.p({label:"科目","label-width":"70",required:!0,name:"subject"}),p:e.o((e=>v.type=e)),q:e.p({localdata:e.unref(_),placeholder:"请选择班型",modelValue:v.type}),r:e.p({label:"班型","label-width":"70",required:!0,name:"type"}),s:e.unref(r.formatSubject)(v.subject)},e.unref(r.formatSubject)(v.subject)?{t:e.o(y),v:e.o(g),w:e.p({title:e.unref(r.formatSubject)(v.subject),options:f.value,placeholder:"请选择老师",selected:v.teacher,saveOptions:S}),x:e.p({label:"教师","label-width":"70",required:!0,name:"teacher"})}:{},{y:e.o(q),z:e.o(w),A:e.p({options:h.value,placeholder:"请选择教室",selected:v.classroom,saveOptions:$}),B:e.p({label:"教室","label-width":"70",required:!0,name:"classroom"}),C:e.o((e=>v.date=e)),D:e.p({type:"date",placeholder:"请选择日期",modelValue:v.date}),E:e.p({label:"日期","label-width":"70",required:!0,name:"date"}),F:e.o(A),G:e.o((e=>v.time=e)),H:e.p({modelValue:v.time}),I:e.p({label:"时间","label-width":"70",required:!0,name:"time"}),J:e.sr(l,"9951b953-8,9951b953-6",{k:"form"}),K:e.p({rules:x.value,model:v}),L:e.o(M),M:e.o(F),N:e.sr(O,"9951b953-6",{k:"popup"}),O:e.p({type:"center"})})}},i=e._export_sfc(u,[["__scopeId","data-v-9951b953"]]);wx.createPage(i);
